Задача: написать запрос на языке sql и перевести на язык алхимии

получаем поле room_id, кол-во бронирований из таблицы bookings
фильтруем по датам заезда и выезда, что бы получить id номеров и количество
группируем по полю room_id, который яв-ся идентификатором номеров
и эти данные поместим в табличное выражение по имени rooms_count

```python
with rooms_count as (
        select room_id, count( *) as rooms_booked from bookings
where date_from <= '2024-07-10' and date_to >= '2024-07-10'
group by room_id)
```

из выражения rooms_count можем получить атрибут room_id из таблицы бронирований и кол-во объектов
бронирований

создаем табличное выражение по имени rooms_left_table
из которого получаем значения idшек номеров, которому даем имя room_id, получаем кол-во свободных номеров
вычитая из кол-ва номеров кол-во бронирований и даем этому атрибуту имя rooms_left
берем эти значения из таблицы rooms from rooms
объединяем с табличным выражением rooms_count по идентификаторам

```python
rooms_teft_table as (
    select rooms.id as room_id, quantity - coalesce(rooms_booked, 0) as rooms_left
from rooms
    left

join
rooms_count
on
rooms.id = rooms_count.room_id)
```

в предыдущем запроем получили табличное выражение по имени rooms_left_table,
котрый выводит поле по имени room_id, в котором хранятся значения уникальных идентификаторов номеров
второе поле по имени rooms_left которое хранит вычисленное значение кол-во свободных номеров
(разницу между rooms.quantity - rooms_booked(бронирования))

в этом запросе сначала получаем значение id из таблицы номеров где hotel_id=54
далее выводим все значения из табличного выражения rooms_left_table
при условии что значение в атриубтуе rooms_left, то есть кол-во номеров больше нуля
таким образом получаем поля room_id, rooms_left, если есть свободные номера

```python
select *
from rooms_teft_table

where
rooms_left > 0 and room_id in (select id from Rooms where hotel_id=54);
```

```python
with rooms_count as (
        select room_id, count( *) as rooms_booked from bookings
where date_from <= '2024-07-10' and date_to >= '2024-07-10'
group by room_id),
rooms_teft_table as (select rooms.id as room_id, quantity - coalesce(rooms_booked, 0) as rooms_left
from rooms
    left

join
rooms_count
on
rooms.id = rooms_count.room_id)
select *
from rooms_teft_table

where
rooms_left > 0 and room_id in (select id from Rooms where hotel_id=54);
```

```python

class RoomsRepository(BaseRepository):
    model = RoomsOrm
    schema = Room

    async def get_all(self,
                      title,
                      description,
                      ):
        query = select(RoomsOrm)
        if title:
            query = query.filter(RoomsOrm.title.ilike(f"%{title}%"))
            print("query_title=", query)
        if description:
            query = query.filter(RoomsOrm.description.ilike(f"%{description}%"))
            print("query_description=", query)

        result = await self.session.execute(query)
        result = result.scalars().all()

        return result

    async def get_filtered_by_time(
            self,  # ссылка на объект экземпляра
            hotel_id,
            date_from: date,  # атрибут дата заселения
            date_to: date):  # атрибут дата выселения

        rooms_count = (
            select(BookingsOrm.room_id, func.count("*").label("rooms_booked"))
            .select_from(BookingsOrm)
            .filter(
                BookingsOrm.date_from <= date_to,
                BookingsOrm.date_to >= date_from
            )
            .group_by(BookingsOrm.room_id)
        ).cte(name="rooms_count")

        rooms_teft_table = (
            select(
                RoomsOrm.id.label("room_id"),
                (RoomsOrm.quantity - func.coalesce(rooms_count.c.rooms_booked, 0)).label("rooms_left"),
            )
            .select_from(RoomsOrm)
            .outerjoin(rooms_count, RoomsOrm.id == rooms_count.c.room_id)
        ).cte(name="rooms_teft_table")

        rooms_ids_for_hotel = (
            select(RoomsOrm.id)
            .select_from(RoomsOrm)
            .filter_by(hotel_id=hotel_id)
            .subquery(name="rooms_ids_for_hotel")
        )
        rooms_ids_to_get = (
            select(rooms_teft_table.c.room_id)
            .select_from(rooms_teft_table)
            .filter(
                rooms_teft_table.c.rooms_left > 0,
                rooms_teft_table.c.room_id.in_(select(rooms_ids_for_hotel))
            )
        )

        print(rooms_ids_to_get.compile(engine, compile_kwargs={"literal_binds": True}))
        return await self.get_filtered(RoomsOrm.id.in_(rooms_ids_to_get))
```

```python

class BaseRepository:
    model = None
    schema: BaseModel = None

    def __init__(self, session):
        self.session = session

    async def get_filtered(self, *filter, **filter_by):
        query = (
            select(self.model)
            .filter(*filter)
            .filter_by(**filter_by)
        )

        result = await self.session.execute(query)
        return [self.schema.model_validate(model) for model in result.scalars().all()]
```

#############################################################################
Сначала изменим файл получения номеров
