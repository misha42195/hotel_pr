from sqlalchemy.orm import Sessionfrom repositories.rooms import RoomsRepositoryfrom repositories.users import UserRepositoryfrom repositories.hotels import HotelsRepositoryfrom database import async_session_makerfrom utils.db_manager import DBManagerfrom api.dependencies import get_dbfrom fastapi.params import Dependsfrom utils.db_manager import DBManagerfrom typing
import AnnotatedЕсли посмтреть на наш код в api, то мы обнаружим повторяющийся код
в виде

1) повторного использования контекстного менеджера, хотелось бы вынести это в отдельный код

2) Использоваение классов репозитриев внитри бизнес логики(ручки)

Для реализации добавим в файле dependencies.py еще одну зависимость

```python
DBDep = Annotated[DBManager, Depends(get_db())]
```
что здесь написано:
Создаем зависисость по имени DBDep, результатом которого будт возврат значения функции get_db,

```python
async def get_db():
    async with DBManager(async_session_factory=async_session_maker) as db:
        yield db
```

Возвращаемый объект db это асинхронный контекстный 
менеджер внутри которого реализованы магические методы соединения и закрытия с БД,
а так же метод для коммита, то есть сохранения позле изменения или обновления данных
```python

class DBManager:
    def __init__(self, session_factory):
        self.session_factory = session_factory

    async def __aenter__(self):
        self.session: Session = self.session_factory()

        self.hotels = HotelsRepository(self.session)
        self.users = UserRepository(self.session)
        self.rooms = RoomsRepository(self.session)

        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        self.session.roolback()
        self.session.close()

    async def commit(self):
        self.session.commit()
```

Далее реализуем в файле dependencies.py зависимость
DBDep, которая будет экземпляром объекта db

```python
from src.database import async_session_maker
from src.utils.db_manager import DBManager


async def get_db():
    async with  DBManager(session_factory=async_session_maker) as db:
        yield db
        


DBDep = Annotated[DBManager, Depends(get_db)]

```
