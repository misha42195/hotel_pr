Наша задача: посчитать кол-во свободных и занятых номеров, если есть хотя бы
один свободый номер, то показать его, или общее кол-во свободных номеров

На данный момент мы получили только агрегированный данные

В таблице rooms есть поле quantity, количество номеров

Для того что бы вывести
CTE - общее табличное выражение, которое позволяет
декомпозировать(разбить запросы на подзапросы)

заезд '2024-07-01'
выезд '2024-07-07'

получаем все бронирования и сортируем по id

```SQL
select * from bookings
order by id 
```

выводим кол-во бронирований и группирем по типу номеров по полю room_id

```sql 
select room_id, count(*) выводим поле room_id, считаеем кол-во бронирований 
from bookings из таблицы бронирований
group by room_id группиреем по полю room_id 
```

```sql
select * from rooms выводим все поля из таблицы номеров
```

получение пересекающихся бронирований на даты бронирования пользователя

```sql
select room_id , count(*) выводим поле room_id, выводим кол-во бронирований 
from bookings из таблицы бронирований, только те объекты бронирований где поля заезда и выезда удовлетворяют условиям
where bookings.date_from <= '2034-12-15' and bookings.date_to >= '2024-07-01'
group by room_id группируем по полю room_id
```

получим кол-во свободных номеров, для этого в в таблице номера есть поле quantity
вычтем из кол-во всех номеров - кол-во бронирований на указанный период
для этого нам надо таблицу с номерами rooms объеденить с тем, что мы посчитали

CTE-общее табличное выражение

Получим кол-во свободных номеров, для этого в таблице номера есть поле quantity
вычтем из кол-во всех номеров - кол-во бронирований на указанный период

```sql составляем CTE табличное выражение получения кол-ва бронирований 
with rooms_count as ( 
    select room_id , count(*) as rooms_bookt from bookings 
    where date_from <= '2024-12-10' and bookings.date_to >= '2024-07-01'
    group by room_id 	
)
select rooms.id as room_id, quantity as rooms_quntity, rooms_bookt, quantity - coalesce(rooms_bookt,0) as room_left
from rooms
left join  rooms_count on rooms.id = rooms_count.room_id 
```

мы получили таблицу в которой поле room_left показывает количесто свободных номеров
и нам надо отдавать номера, в которых это значение больше нуля

```sql
with rooms_count as (
    select room_id , count(*) as rooms_bookt from bookings 
    where date_from <= '2024-07-10' and bookings.date_to >= '2024-07-01'
    group by room_id 	
),
rooms_left_table as (
	select rooms.id as room_id, quantity - coalesce(rooms_bookt,0) as room_left
	from rooms
	left join  rooms_count on rooms.id = rooms_count.room_id
)
select * from rooms_left_table
where room_left > 0
```

with rooms_count as (select room_id, count(*) as count_bookings
from bookings
where date_from <='2024-12-25' and date_to >='2024-07-01'
group by room_id
),
rooms_left_table as (
select rooms.id as room_id, rooms.quantity - coalesce(rooms_count.count_bookings, 0) as rooms_left
from rooms
left join rooms_count on rooms.id = rooms_count.room_id
)
select * from rooms_left_table
where rooms_left > 0
